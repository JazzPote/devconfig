#!/bin/bash

########################################################

#
# Usage:
#
# $ updateDotenv  [-p]  path/to/.env.example  path/to/.env
#
#
########################################################


purge=""
verbose=""

while getopts "pv" opt; do
    case "$opt" in
        p)
            purge="yes"
            ;;
        v)
            verbose="yes"
            ;;
        \?)
            exit 1;
    esac
done
shift $(( $OPTIND - 1  ))


[[ $# -ne 2 ]] && { echo "You must supply 2 arguments" >&2; exit 1; }

example="$1"
dotenv="$2"


# First, let's check the command is called with correct arguments
# ---------------------------------------------------------------

# Are the paths corrects?
[[ "$example" != *.env.example ]] && { echo "Error: You must provide a path to the .env.example file as the first argument" >&2; exit 1; }
[[ "$dotenv" != *.env ]] && { echo "Error: You must provide a path to the .env file as the first argument" >&2; exit 1; }

# Do the files exist?
[[ ! -e "$example" ]] && { echo "Error: Can't find ${example}" >&2; exit 1; }
[[ ! -e "$dotenv" ]] && { echo "Error: Can't find ${dotenv}" >&2; exit 1; }


# Actual logic
# ------------------------

# List all the vars in files
exampleVars=( $(grep -oE '^\w+=' "$example"  | cut -d = -f 1) )
dotenvVars=( $(grep -oE '^\w+=' "$dotenv"  | cut -d = -f 1) )

# Compare them and add if missing to .env
(( count=0 ))
for exampleVar in "${exampleVars[@]}"; do
    if [[ ! "${dotenvVars[@]}" =~ "$exampleVar" ]]; then
        [[ $verbose ]] && printf "Adding %s..." "$exampleVar"
        missingVarWithValue=$(grep "$exampleVar" "$example" |head -n 1)
        (( count == 0 )) && echo "" >> "$dotenv"
        (( ++count ))
        echo "$missingVarWithValue" >> "$dotenv"
        [[ $verbose ]] && printf "OK\n"
    fi
done

# Ensure file ends with empty line
(( count > 0 )) && echo "" >> "$dotenv"

if (( $count )); then
    echo "${count} variables have been added with success"
else
    echo "Nothing to update"
fi


(( count = 0 ))
for dotenvVar in "${dotenvVars[@]}"; do
    if [[ ! "${exampleVars[@]}" =~ "$dotenvVar" ]]; then
        (( ++count ))
        if [[ $purge ]]; then
            tmpdotenv="/tmp/tmpdotenv"
            [[ $verbose ]] && printf "Purging %s..." "$dotenvVar"
            grep -vw "$dotenvVar" "$dotenv" > "$tmpdotenv"
            mv "$tmpdotenv" "$dotenv"
            [[ $verbose ]] && printf "OK\n"
        fi
    fi
done

if [[ $purge ]]; then
    (( count > 0 )) && echo "${count} variables purged with success"
elif (( count > 0 )); then
    echo "${count} variables can be purged"
fi

exit 0

